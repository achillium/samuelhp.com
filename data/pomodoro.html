<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Calendar Heatmap</title>
  <script src="https://d3js.org/d3.v7.min.js"></script>
  <style>
    body {
      font-family: sans-serif;
      display: flex;
      justify-content: center;
      margin-top: 40px;
      background: #ffffff;
      color: #24292f;
    }

    svg {
      overflow: visible;
    }

    .day {
      shape-rendering: crispEdges;
      stroke: #d0d7de;
      stroke-width: 1px;
    }

    .month-label {
      fill: #57606a;
      font-size: 10px;
    }

    .tooltip {
      position: absolute;
      padding: 6px 10px;
      background: #ffffff;
      color: #24292f;
      border: 1px solid #d0d7de;
      border-radius: 4px;
      font-size: 12px;
      pointer-events: none;
      opacity: 0;
      transition: opacity 0.15s;
      box-shadow: 0 2px 6px rgba(0,0,0,0.1);
    }
  </style>
</head>
<body>
  <svg id="heatmap" width="950" height="150"></svg>
  <div class="tooltip" id="tooltip"></div>

  <script>
    const width = 950;
    const cellSize = 12;
    const padding = 4;
    const yearDays = 365;

    const today = new Date();
    // Make sure we end at today, not tomorrow
    const endDate = d3.timeDay.floor(today);
    const startDate = d3.timeDay.offset(endDate, -yearDays + 1);

    const svg = d3.select("#heatmap");
    const tooltip = d3.select("#tooltip");

    d3.csv("./pomodoro/history.csv").then(data => {
      // Count entries per End Date
      const counts = d3.rollup(
        data,
        v => v.length,
        d => d["End Date"]
      );

      const colorScale = d3.scaleThreshold()
        .domain([1, 2, 3, 5, 10])
        .range(["#ebedf0", "#9be9a8", "#40c463", "#30a14e", "#216e39"]);

      const days = d3.timeDays(startDate, d3.timeDay.offset(endDate, 1));

      const g = svg.append("g")
        .attr("transform", `translate(25, 20)`);

      g.selectAll(".day")
        .data(days)
        .join("rect")
        .attr("class", "day")
        .attr("width", cellSize)
        .attr("height", cellSize)
        .attr("x", d => d3.timeWeek.count(startDate, d) * (cellSize + padding))
        .attr("y", d => d.getDay() * (cellSize + padding))
        .attr("rx", 2).attr("ry", 2)
        .attr("fill", d => {
          const dateStr = d.toISOString().slice(0, 10);
          const count = counts.get(dateStr) || 0;
          return colorScale(count);
        })
        .on("mouseover", function (event, d) {
          const dateStr = d.toISOString().slice(0, 10);
          const count = counts.get(dateStr) || 0;
          tooltip
            .style("opacity", 1)
            .html(`${count} entr${count === 1 ? "y" : "ies"}<br>${dateStr}`)
            .style("left", event.pageX + 10 + "px")
            .style("top", event.pageY - 20 + "px");
        })
        .on("mouseout", () => tooltip.style("opacity", 0));

      // Month labels
      g.selectAll(".month-label")
        .data(d3.timeMonths(startDate, endDate))
        .join("text")
        .attr("class", "month-label")
        .attr("x", d => d3.timeWeek.count(startDate, d) * (cellSize + padding))
        .attr("y", -5)
        .text(d3.timeFormat("%b"));
    });
  </script>
</body>
</html>
